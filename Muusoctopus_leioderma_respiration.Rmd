---
title: "Muusoctopus leioderma respiration"
author: "Lloyd Trueblood and Kirt Onthank"
date: "9/23/2021"
output: pdf_document
---

# Reading in libraries
```{r}
library(OTools)
library(xlsx)
library(nlme)
library(car)
library(emmeans)
library(respirometry)
```

# Find the relevant files
```{r}
files=list.files(recursive=T)
resp.files=grep(".txt",files,value=T)
pcrit.files=grep("pcrit|pcrti",resp.files,value=T,ignore.case=T)
metab.files=setdiff(resp.files,pcrit.files)
blank.files=grep("blank_only",resp.files,value=T,ignore.case=T)
rmr.files=setdiff(metab.files,blank.files)
rmr.files=rmr.files[!grepl("-ch2.txt|-ch3.txt|-ch4.txt|\\(1\\).txt",rmr.files)]
rmr.files=rmr.files[!duplicated(basename(rmr.files))]
```


# Reading in the data log xlsx file
```{r}
data.log=read.csv("Muus_Data_Log.csv")
```

# Running the RMR data analysis
First I am going to make a object to put the RMR data into
```{r}
routine=data.frame(filename=as.character(),spreadsheet_guess=as.character(),octo=as.character(),mass=as.numeric(),pco2=as.numeric(),day=as.numeric(),rmr=as.numeric())
```


filename match check
```{r}
file_check=as.character()
for (i in 1:length(rmr.files)){
  filename=rmr.files[i]
  guess=which.min(adist(basename(filename),data.log$File.name))
  file_check[i]=data.log$File.name[guess]
}

write.csv(cbind(basename(rmr.files),file_check),file = "filecheck.csv")

i=27
cbind(t(adist(basename(rmr.files[i]),data.log$File.name)),basename(rmr.files),basename(rmr.files)[i])

sum(is.na(resp$O23))<10&!grepl("blank",filename)
```


```{r}
column.count=1
for (i in 1:length(rmr.files)){
  filename=rmr.files[i]
  print(paste("starting file ", basename(filename)," (loop",i,")",sep=""))
  if(length(grep("Group 4|presens|ch\\d\\.txt",basename(filename)))>0){
    resp=read.presens(filename)
  }else{
    resp=read.pyro(filename)
  }
  print("finding closest match in log")

guess=which.min(adist(basename(filename),data.log$File.name))
  
    flow=as.numeric(data.log$flow.rate..L.min.[guess])
    mass=as.numeric(data.log$Mass..g.[guess])
    if(is.na(flow)){
      flow=0.1
    }
    if(is.na(mass)){
      mass=10
    }
    print("calculating rmr")
    resp.mean=mean(resp.open(resp[resp$times>3600*3,],flow.rate=flow*1000,weight=mass)$resp,na.rm=T)
    print("writing data to object")
    routine[column.count,1]=basename(filename)
    routine[column.count,2]=data.log$File.name[guess]
    routine[column.count,3]=data.log$octo1[guess]
    routine[column.count,4]=mass

    if(length(grep("1800",filename))>0){
     routine[column.count,5]=1800
    }
    if(length(grep("1000",filename))>0){
      routine[column.count,5]=1000
    }
    routine[column.count,6]=data.log$day[guess]
    routine[column.count,7]=resp.mean
    column.count=column.count+1
    if(sum(is.na(resp$O23))<10&!grepl("blank",filename)){
      print("found second respirometer")
      flow=as.numeric(data.log$Flow.rate.2[guess])
      mass=as.numeric(data.log$Mass.2[guess])
      resp.mean=mean(resp.open(resp[resp$times>3600,],inflow=3,outflow=4,flow.rate=flow*1000,weight=mass)$resp,na.rm=T)
      print("writing data to object")
      routine[column.count,1]=basename(filename)
      routine[column.count,2]=data.log$File.name[guess]
      routine[column.count,3]=data.log$octo2[guess]
      routine[column.count,4]=mass
  
      if(length(grep("1800",filename))>0){
       routine[column.count,5]=1800
      }
      if(length(grep("1000",filename))>0){
        routine[column.count,5]=1000
      }
      routine[column.count,6]=data.log$day[guess]
      routine[column.count,7]=resp.mean
      column.count=column.count+1
    }
  print(paste("end of file ", basename(filename)," (loop",i,")",sep=""))
}



```


```{r}
write.csv(routine,"RMR_Results.csv")
```

# Plotting Something
```{r}
plot(rmr~mass,data=routine,log="xy")
```


# Running linear effects model

## setting pCO2 to factor class:
```{r short_input}
routine$pco2=as.factor(routine$pco2)
```

## Next I set orthogonal contrasts:
```{r short_contrast}
contrasts(routine$pco2)=contr.poly(2) 
```

## Running the linear mixed effects model and ANOVA using type III sum of squares:
```{r linear mixed effects model}
routine.lme=lme(rmr~mass*pco2*day,random=~1|octo,
#             correlation=corAR1(form=~day|octo),
              data=routine)
Anova(routine.lme,type="III")
```

```{r}
emmeans(routine.lme,~day*mass*pco2)
```


# Running blanks

```{r}
blank.files=grep("blank",resp.files,value=T,ignore.case=T)
```


# Pcrit analysis

```{r}
pcrit.files=pcrit.files[!duplicated(basename(pcrit.files))]
write.csv(basename(pcrit.files),file = "pcrit_log.csv")
```


```{r}


pcrit.raw=read.pyro(pcrit.files[5])
plot(pcrit.raw$O21~pcrit.raw$times,type="l",axes=F,ylab="",xlab="",main=basename(pcrit.files[1]))
abline(v=seq(from=0,to=100000,by=1000),col="grey")



```
```{r}
```


```{r}
muus.resp=resp.closed(pcrit.raw,volume=.025,weight=25,smooth="loess",channel=2,smooth.span=0.1)
plot_pcrit(muus.resp$po2[complete.cases(muus.resp)],muus.resp$resp[complete.cases(muus.resp)],MR=2.00,avg_top_n=3)

calc_pcrit(muus.resp$po2[complete.cases(muus.resp)],muus.resp$resp[complete.cases(muus.resp)], MR = 2.6)

```




```{r}
library(remotes)
install_github("KirtOnthank/OTools")
```

